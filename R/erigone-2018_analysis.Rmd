---
title: "Erigone project 2018 - script"
author: - "**Maxime Dahirel** (script author)"
date:
output: 
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## **Introduction**

The aims of this study were to:

*to add*

## **Starters and data wrangling**

*to complete*

```{r load-packages}
library(arm)
library(matrixStats)

library(nadiv)

library(cmdstanr) ## Stan backend
library(brms) ## the interface we are using
library(tidyverse)
library(bayesplot)
library(tidybayes)
library(patchwork) #plotting
library(lubridate) ## conflict with here

library(here)

options(mc.cores = 4)
```


```{r load-raw-datafiles}
## Load raw datasets
data_main <- read_csv(here("data","erigone2018_females.csv"),
                      col_types = cols(sex=col_character())) %>%  ##only females "F", if not given, will parse as logical
            filter(generation > 0) # we only keep lab-born spiders for this analysis
## should do better, use date of birth

data_mothers <- read_csv(here("data","erigone2018_females.csv"),
                      col_types = cols(sex=col_character())) %>%
            filter(generation <2) %>% 
  select(MOTHER= ID,
         CT_length1_mom = CT_length1,
         CT_length2_mom = CT_length1,
         CT_width1_mom = CT_width1,
         CT_width2_mom = CT_width2
         )

data_clutches <- read_csv(here("data","erigone2018_cocoons.csv"))

pedigree <- read_csv(here("data","erigone2018_pedigree.csv"))

sites <- read_csv(here("data","erigone2018_sites.csv"))

## see later for environmental data, and male data
```

our choice of life history metrics is inspired (but not 100% identical) to Healy et al 2019 NEE:

- Age at maturity (don't forget your notes on the use of interval sampling)
- Adult longevity
- Lifetime fecundity (number of eggs, number of cocoons)
- Spread of reproduction through lifetime (to do; they use a Gini index, but their methods only really work with regular age classes, I think)

We add to that

- body size information
- dispersal information (presence/absence of dispersal-relate dbehaviours; rappelling frequencies) . Note: the original data collection plan also included information about latency to tiptoe and number of tiptoe events even if they were not followed by rappelling, but due to miscommunication on my side, the two data collectors (me and MW) did not agree on how to count tiptoes in these columns (should we count all tiptoes vs only tiptoes that were not followed by rappelling). As a result data entered in these columns is meaningless and not used or reproduced here

```{r data-wrangling-1}
fecundity <- data_clutches %>% 
  group_by(ID) %>% 
  summarise(lifetime_fecundity=sum(N_spiderlings),
            N_cocoons=sum(N_cocoons),
            N_cocoons_hatched=sum(Cocoon_hatched))


development_density <- data_clutches %>% 
  select(MOTHER=ID,
         date_egg=date_laying,
         density=N_spiderlings,
         clutch_order=clutchID)

data <- left_join(data_main,fecundity) %>%
  mutate(animal = ID) %>% 
  left_join(pedigree) %>% 
  left_join(development_density) %>% 
  left_join(data_mothers) %>% 
  mutate(lifetime_fecundity=replace_na(lifetime_fecundity,0), 
         ###individuals with no record in the fecundity are not NA, they failed to reproduce
         N_cocoons=replace_na(N_cocoons,0),
         N_cocoons_hatched=replace_na(N_cocoons_hatched,0)) %>% 
  mutate(time_to_maturity = (ymd(date_maturity)-ymd(date_hatching)) %>%  as.numeric(),
         adult_longevity = (ymd(date_death)-ymd(date_maturity)) %>%  as.numeric()
         ) %>% 
  mutate(generation = factor(generation),
         clutchID = paste(MOTHER,"-",as.character(date_egg),sep="")###wild are assumed to not be direct siblings, all count as their own clutch
  )
```

```{r general-model-trialversion}
data$adult_censored <- (data$outlived_experiment==TRUE | data$accidental_death==TRUE)
data$delay_egg=scale(as.numeric(ymd(data$date_mating)-ymd(data$date_maturity)))[,1]
data$had.mate<- (is.na(data$date_mating)==FALSE)


data$CT_width=(data$CT_width1+data$CT_width2)/2
data$s_CT_width=scale(data$CT_width)[,1]


data$CT_length=(data$CT_length1+data$CT_length2)/2
data$s_CT_length=scale(data$CT_length)[,1]


data$s_CT_width=replace_na(data$s_CT_width,0)
data$s_cT_length=replace_na(data$s_CT_length,0)
```

# models

first a model for the phenotypic correlation:

```{r}

bf_dispersal<-bf(N_rappelling~ landscape + 
             (1|patch)+
             (1|r|ID),family=poisson)

bf_devtime<-bf(time_to_maturity~ landscape + 
             (1|patch)+
             (1|r|ID),family=poisson)

bf_longevity<-bf(adult_longevity|cens(adult_censored)~ landscape + 
             (1|patch)+
             (1|r|ID),family=poisson)


bf_LRS<-bf(lifetime_fecundity|cens(adult_censored) + subset(had.mate) ~ landscape + delay_egg + 
             (1|patch)+
             (1|r|ID),family=poisson)


prior<-c(
  set_prior("normal(0,1)",class="Intercept",resp=c("Nrappelling")),
  set_prior("normal(3.4,1)",class="Intercept",resp=c("timetomaturity","lifetimefecundity","adultlongevity")),
  ### bonte pnas and duffey (longipalpis) suggest a month or 30-40 eggs (exp(3.4)) is a good ballpark prior
  set_prior("normal(0,1)",class="b",resp=c("Nrappelling","lifetimefecundity")),
  set_prior("normal(0,1)",class="b",resp=c("timetomaturity","adultlongevity")),
  set_prior("normal(0,1)",class="sd",resp=c("Nrappelling","timetomaturity","lifetimefecundity","adultlongevity")),
  set_prior("lkj(3)",class="cor")
)

mod=brm(mvbf(bf_dispersal+bf_devtime+bf_LRS+bf_longevity),
        data=data,iter=4000,warmup=2000,data2=list(A=A),chains=4,prior=prior, ##4000/2000 works, but a few are below the 400bulk/400tail minimum threshold in Vehtari
        # 4000 2000 works
        # takes about two hours to run
        # now what happens if i had longevity, if I interval censor devtime
        # if i use only rappelling and when I split covar in west/east
        control=list(adapt_delta=0.95,max_treedepth=15),
        seed=42,
        backend="cmdstanr")
```

then a model where we split this into "relatedness + common environment" and residual (or within and among families, in the parlance of lynch walsh):

we cannot go further and include father info since it is missing for G1, and we cannot assume that wild caught females only mated with one male (which would allow us to add these phantom males to the pedigree) since there is indication that erigone females mate multiple times (anecdote in de meester bonte 2010 among others,see also Comparative  study  of  courtship  and  copulation  in  fiveOedothorax species)

```{r}

bf_dispersal<-bf(N_rappelling~ landscape + 
             (1|patch)+
             (1|q|MOTHER)+
             (1|r|ID),family=poisson)

bf_devtime<-bf(time_to_maturity~ landscape + 
             (1|patch)+
             (1|q|MOTHER)+
             (1|r|ID),family=poisson)

bf_longevity<-bf(adult_longevity|cens(adult_censored)~ landscape + 
             (1|patch)+
             (1|q|MOTHER)+
             (1|r|ID),family=poisson)


bf_LRS<-bf(lifetime_fecundity|cens(adult_censored) + subset(had.mate) ~ landscape + delay_egg + 
             (1|patch)+
             (1|q|MOTHER)+
             (1|r|ID),family=poisson)


prior<-c(
  set_prior("normal(0,1)",class="Intercept",resp=c("Nrappelling")),
  set_prior("normal(3.4,1)",class="Intercept",resp=c("timetomaturity","lifetimefecundity","adultlongevity")),
  ### bonte pnas and duffey (longipalpis) suggest a month or 30-40 eggs (exp(3.4)) is a good ballpark prior
  set_prior("normal(0,1)",class="b",resp=c("Nrappelling","lifetimefecundity")),
  set_prior("normal(0,1)",class="b",resp=c("timetomaturity","adultlongevity")),
  set_prior("normal(0,1)",class="sd",resp=c("Nrappelling","timetomaturity","lifetimefecundity","adultlongevity")),
  set_prior("lkj(3)",class="cor")
)

mod=brm(mvbf(bf_dispersal+bf_devtime+bf_LRS+bf_longevity),
        data=data,iter=4000,warmup=2000,data2=list(A=A),chains=4,prior=prior, ##4000/2000 works, but a few are below the 400bulk/400tail minimum threshold in Vehtari
        # 4000 2000 works
        # takes about two hours to run
        # now what happens if i had longevity, if I interval censor devtime
        # if i use only rappelling and when I split covar in west/east
        control=list(adapt_delta=0.95,max_treedepth=15),
        seed=42,
        backend="cmdstanr")
```

we find that most of the syndrome is driven by within-family variation (something that would not have been visible from the attempt at doing an animal model)



















### annex what about an animal model?


```{r data-wrangling-pedigree}
# we use nadiv to get the A matrix from the pedigree

genealogy <- pedigree[c("animal","MOTHER","FATHER","sex")] %>% 
  as.data.frame() %>% 
  prepPed(gender="sex") ##why is the default name of that column "gender" in that package FFS? changed to "sex"


A<-makeA(genealogy[,1:3]) %>%  # to make the A matrix, input has to contain only ID, Dam, Sire in that order
         as.matrix() #unsparsify
```





