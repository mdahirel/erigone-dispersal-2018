---
title: "Supplementary Material for \"Dispersal syndrome and landscape fragmentation in the salt-marsh specialist spider *Erigone longipalpis*\""
author: Maxime Dahirel, Marie Wullschleger, Tristan Berry, Solène Croci, Julien Pétillon
output: pdf_document
editor_options:
  chunk_output_type: console
header-includes:
  - \usepackage[left]{lineno}
  - \linenumbers
  - \renewcommand\linenumberfont{\normalfont\bfseries\small}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE)
```
<!--note to self to check the jitter on figures to be sure that 4 or 5 patches west, 3 patches east in the "only main patches" config-->

```{r load-packages}
library(arm)
library(matrixStats)

## spatial stuff
#library(ggmap) #still needed?? not sure
library(ggspatial)
library(osmdata)
library(sf)

## pedigree stuff (still needed??)
library(nadiv)

library(cmdstanr) ## Stan backend
library(brms) ## the interface we are using
library(tidyverse)
library(bayesplot)
library(tidybayes)
library(ggtext)
library(patchwork) #plotting
library(lubridate) ## conflict with here

library(here)

options(mc.cores = 4)
```

```{r load-raw-datafiles}
## Load raw datasets
data_main <- read_csv(here("data","erigone2018_females.csv"),
                      col_types = cols(sex=col_character())) %>%  
  ##only females "F", so if col_types not given explicitly, "sex" column is parsed as logical
            filter(generation > 0) # we only keep lab-born spiders for this analysis

###NOTE to round sizes to nearest 0.1mm, with clear indication that raw-raw data are "more precise" but that's just artifact from 
## measurement software


data_mothers <- read_csv(here("data","erigone2018_females.csv"),
                      col_types = cols(sex=col_character())) %>%
            filter(generation <2) %>% 
  select(MOTHER= ID,
         CT_length1_mom = CT_length1,
         CT_length2_mom = CT_length1,
         CT_width1_mom = CT_width1,
         CT_width2_mom = CT_width2
         )

data_clutches <- read_csv(here("data","erigone2018_cocoons.csv"))

pedigree <- read_csv(here("data","erigone2018_pedigree.csv"))

sites <- read_csv(here("data","erigone2018_sites.csv"))

pairings <- read_csv(here("data","erigone2018_pairings.csv"))

## see later for environmental data, and male data
```
<!--start of a block of recreation of data, could be best to put up a write_csv in main code-->
```{r}
fecundity <- data_clutches %>% 
  group_by(ID) %>% 
  summarise(lifetime_fecundity=sum(N_spiderlings),
            N_cocoons=sum(N_cocoons),
            N_cocoons_hatched=sum(Cocoon_hatched))


data <- left_join(data_main,fecundity) %>%
  mutate(animal = ID) %>% 
  left_join(pedigree) %>% 
  mutate(lifetime_fecundity=replace_na(lifetime_fecundity,0), 
         ###individuals with no record in the fecundity are not NA, they failed to reproduce
         ### but in some cases it may be beccause no mating; we'll account for that in analysis
         N_cocoons=replace_na(N_cocoons,0),
         N_cocoons_hatched=replace_na(N_cocoons_hatched,0),
         N_rappelling=replace_na(N_rappelling,0)
         ## we do the same for rappelling, a few NA because died before dispersal
         ## but for some downstream methods we need something with no NAs
         ## so dummy variables
         ) %>% 
  mutate(time_to_maturity = (ymd(date_maturity)-ymd(date_hatching)) %>%  as.numeric(),
         adult_longevity = (ymd(date_death)-ymd(date_maturity)) %>%  as.numeric()
         ) %>% 
  mutate(generation = factor(generation),
         clutchID = paste(MOTHER,"-",as.character(date_egg),sep="")###wild are assumed to not be direct siblings, all count as their own clutch
  ) %>% 
  mutate(obsgap_maturity=case_when(date_maturity=="2018-05-22" | date_egg=="2018-05-22" ~ "yes",
                             wday(date_maturity,week_start=1)==1 | wday(date_egg,week_start=1)==1 ~ "yes",
                             date_maturity=="2018-05-02" | date_egg== "2018-05-02" |
                               date_maturity=="2018-05-09" | date_egg=="2018-05-09" ~ "yes",
                             T~ "no")) %>% 
  mutate(obsgap_longevity=case_when(date_maturity=="2018-05-22" | date_death=="2018-05-22" ~ "yes",
                             wday(date_maturity,week_start=1)==1 | wday(date_death,week_start=1)==1 ~ "yes",
                             date_maturity=="2018-05-02" | date_death== "2018-05-02" |
                               date_maturity=="2018-05-09" | date_death=="2018-05-09" ~ "yes",
                             T~ "no"))

## we add variables that say whether or not one of the two observations that govern phase duration
## were made right after a gap in observation (WE, holdays, other)
## leading to potential bias
data$adult_censored <- (data$outlived_experiment==TRUE | data$accidental_death==TRUE)
data$time_for_repro=as.numeric(ymd(data$date_death)-ymd(data$date_mating))
data$had.mate<- (is.na(data$date_mating)==FALSE)

temp_length<- data %>%
  select(ID,CT_length1,CT_length2) %>% 
  pivot_longer(cols=c(CT_length1,CT_length2),
               names_to = "size_measurement",
               names_prefix="CT_length",
               values_to="CT_length") 

temp_width<- data %>%
  select(ID,CT_width1,CT_width2) %>% 
  pivot_longer(cols=c(CT_width1,CT_width2),
               names_to = "size_measurement",
               names_prefix="CT_width",
               values_to="CT_width") 

temp_size=left_join(temp_length,temp_width)

data<-data %>% 
  select(-c(CT_length1,CT_length2,CT_width1,CT_width2)) %>% 
  left_join(temp_size) %>% 
  mutate(s_CT_width=scale(CT_width)[,1],
         s_CT_length=scale(CT_length)[,1]) %>% 
  mutate(landscape=fct_relevel(landscape,"west",after=0))

data$is.valid_dispersal=as.numeric(data$size_measurement==1 & 
                            data$natural_death_before_dispersal==0)

data$is.valid_maturity=as.numeric(data$size_measurement==1)

data$is.valid_fecundity=as.numeric(data$time_for_repro>0 & 
                                     data$had.mate ==TRUE &  ## so we exclude all unmated spiders and spiders that did not have time to lay eggs
                            data$size_measurement==1)

data$is.valid_longevity=as.numeric(data$size_measurement==1)
```
<!--end of "data" recreation block-->

# Supplementary Material 1. Difference in habitat availability between the two focal "landscapes"

```{r}
map_points<-st_read(here("data","erigone2018_GISlayers.gpkg"),
        layer="sampling_sites",
        quiet=TRUE)

map_patches<-st_read(here("data","erigone2018_GISlayers.gpkg"),
        layer="habitat_type",
        quiet=TRUE)
```

```{r}
## we create a sf with only favourable patches
favourable=map_patches %>% 
  filter(plant=="puccinellia_dominant")

buffers1000=st_buffer(map_points,dist=1000)

sum_areas=st_intersection(st_make_valid(favourable),buffers1000) %>% 
  mutate(area=st_area(geom)) %>% 
  group_by(name) %>% 
  summarise(area=sum(area,na.rm = TRUE)) %>% 
  st_drop_geometry() %>% 
  select(patch=name,area)
## a warning here that may need to be checked

habitat_avail=left_join(sites,sum_areas) %>% 
  filter(is_habitat=="y") %>% 
  mutate(percent_area=100*as.numeric(area)/(pi*1000*1000)) %>% 
  mutate(landscape=fct_relevel(landscape,"west",after=0))
##just reordering so that west=left in plots

#habitat_avail %>% 
#  group_by(landscape) %>% 
#  summarise(mean=mean(percent_area),
#            min=min(percent_area),
#            max=max(percent_area)
#            )

habitat_avail %>% 
  ggplot()+
  geom_jitter(aes(landscape,percent_area),position=position_jitter(width=0.1))+
  scale_y_continuous(" % of favourable habitat within a 1000m radius")+
  theme_bw()+
  theme(axis.title.y=element_markdown())
```

**Supplementary Figure S1.1.** Proportion of land and sea cover occupied by favourable habitat (i.e. *Puccinellia maritima*-dominated lawns) within a 1000m radius of each sampling site, as a function of landscape.

# Supplementary Material 2. Relationship between the numbers of lab-born spiders and wild-caught spiders sourced from a patch

```{r}
count_females <- read_csv(here("data","erigone2018_females.csv"),
                      col_types = cols(sex=col_character())) %>%  
  ##only females "F", so if col_types not given explicitly, "sex" column is parsed as logical
  mutate(wild=generation ==0) %>%
  group_by(wild, patch) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(wild=paste0("wild_",wild)) %>% 
  pivot_wider(names_from=wild,values_from=n) %>% 
  mutate(wild_FALSE=replace_na(wild_FALSE,0)) %>% 
  rename(n_females_lab = wild_FALSE, n_females_wild = wild_TRUE)

count_males <- read_csv(here("data","erigone2018_males.csv"),
                      col_types = cols(sex=col_character())) %>%  
  filter(generation>0) %>%
  group_by(patch) %>% 
  count() %>% 
  rename(n_males_lab=n)

count_spiders <- left_join(count_females,count_males) %>% 
  mutate(n_males_lab=replace_na(n_males_lab,0))

count_spiders %>% 
  ggplot()+
  geom_point(aes(n_females_wild/sum(n_females_wild),(n_males_lab+n_females_lab)/sum(n_females_lab+n_males_lab)),size=2)+
  geom_abline(intercept=0,slope=1,lty=2)+
  scale_x_continuous("proportion of all wild females coming from patch")+
  scale_y_continuous("proportion of all lab-born adults descending from patch")+
  theme_bw()

```

**Figure S2.1.** Relationship between the relative number of female spiders caught in a patch and the corresponding number of lab-born adults kept. The dashed line corresponds to y = x. Note that the same pattern is found whether the variable on the y-axis is "all adult spiders in the lab" or only the female ones.

# Supplementary Material 3. Detailed description of statistical models

## Spider abundance

The number of spiders $N_{p}$ caught in patch $p$ was analysed using the following model:
$$
N_{p} \sim \mathrm{Poisson}(\lambda_{[N]} \times t_{p}),
$$
$$
\log(\lambda_{[N]})= \beta_{0[N]} + \beta_{1[N]} \times x_{p},
$$
with $t_p$ being an offset corresponding to the patch-specific sampling effort (in person-hours), and $x_p$ a binary variable denoting the landscape to which the patch $p$ belongs (0: the western, more continuous landscape; 1: the eastern, more fragmented landscape). We used weakly informative priors as suggested by <!--REF TO ADD-->, namely $\mathrm{Normal}(0,1)$ for both the intercept $\beta_{0}$ and the landscape effect $\beta_{1}$.

## Spider phenotype

Let $M_{i,p}$, $D_{i,p}$, $F_{i,p}$, $L_{i,p}$ be the *recorded* ages at maturity, dispersal propensity (number of rappelling attempts), fecundity and adult longevity of individual $i$ whose (grand)mother was caught in patch $p$. In addition, let $S_{i,p,o}$ be the observation/measure $o$ of individual $i$'s body size (here cephalothorax width), *after* standardisation to mean 0 and SD 1. Then we can assume these traits are distributed as follows:

$$
S_{i,p,o} \sim \mathrm{Normal}(\mu_{i,p},\sigma_r),
$$
$$
M_{i,p} \sim \mathrm{Poisson}(\lambda_{[M]i,p}),
$$
$$
D_{i,p} \sim \mathrm{Poisson}(\lambda_{[D]i,p}),
$$
$$
F_{i,p} \sim \mathrm{Poisson}(\lambda_{[F]i,p} \times d_{i,p}),
$$

where $d_{i,p}$ is an offset based on the number of potential egg-laying days this individual was observed, and

$$
L_{i,p}|C_{i,p} =0 \sim \mathrm{Poisson}(\lambda_{[L]i,p}),
$$
$$
L_{i,p}|C_{i,p} =1 \sim \mathrm{Poisson\mbox{-}CCDF}(\lambda_{[L]i,p}),
$$
where $C_{i,p}$ is a censoring indicator = 0 if natural death was recorded during the experiment, or = 1 if individuals outlived the experiment or died accidentally.<!--FIND BETTER WAY TO NOTE CENSORSHIP??-->

The models for the corresponding $\mu$ and $\lambda$ are all pretty similar to each other:
$$
\mu_{i,p}=\beta_{0[S]} + \beta_{1[S]} \times x_{p} + \alpha_{[S]p} + \gamma_{[S]i},
$$
$$
\log(\lambda_{[M]i,p})=\beta_{0[M]} + \beta_{1[M]} \times x_{p} + \beta_{2[M]} \times y_{[M]p} + \alpha_{[M]p} + \gamma_{[M]i},
$$
$$
\log(\lambda_{[D]i,p})=\beta_{0[D]} + \beta_{1[D]} \times x_{p} + \alpha_{[D]p} + \gamma_{[D]i},
$$
$$
\log(\lambda_{[F]i,p})=\beta_{0[F]} + \beta_{1[F]} \times x_{p} + \alpha_{[F]p} + \gamma_{[F]i},
$$
$$
\log(\lambda_{[L]i,p})=\beta_{0[L]} + \beta_{1[L]} \times x_{p} + \beta_{2[L]} \times y_{[L]p} + \alpha_{[L]p} + \gamma_{[L]i},
$$
with $y$ a binary variable denoting whether the time-to-event response (time to maturity or longevity) is based on records with gaps (i.e. maturity recorded after a week-end) and thus potentially biased. The random effects of patch of origin and individual identity are denoted by $\alpha$ and $\gamma$ respectively. These random effects are distributed as follows:

$$
\alpha_{[S]p} \sim \mathrm{Normal}(0,\sigma_{\alpha[S]}),
$$
$$
\alpha_{[M]p} \sim \mathrm{Normal}(0,\sigma_{\alpha[M]}),
$$
$$
\alpha_{[D]p} \sim \mathrm{Normal}(0,\sigma_{\alpha[D]}),
$$
$$
\alpha_{[F]p} \sim \mathrm{Normal}(0,\sigma_{\alpha[F]}),
$$
$$
\alpha_{[L]p} \sim \mathrm{Normal}(0,\sigma_{\alpha[L]}),
$$

$$
\begin{bmatrix} \gamma_{[S]i} \\ \gamma_{[M]i} \\ \gamma_{[D]i} \\ \gamma_{[F]i} \\ \gamma_{[L]i} \end{bmatrix} 
\sim 
\textrm{MVNormal}
\begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \\ 0  \end{bmatrix},
\boldsymbol{\Omega}
\end{pmatrix},
$$
where $\boldsymbol{\Omega}$ is the individual-level covariance matrix, which can be decomposed into its constituent standard deviations and correlation matrix $\boldsymbol{R}$ as follows:
$$
\boldsymbol{\Omega} = 
\begin{bmatrix}
\sigma_{\gamma[S]} & 0 & 0 & 0 & 0\\
0 & \sigma_{\gamma[M]} & 0 & 0 & 0\\
0 & 0 & \sigma_{\gamma[D]} & 0 & 0\\
0 & 0 & 0 & \sigma_{\gamma[F]} & 0\\
0 & 0 & 0 & 0 & \sigma_{\gamma[L]}
\end{bmatrix}
\boldsymbol{R}
\begin{bmatrix}
\sigma_{\gamma[S]} & 0 & 0 & 0 & 0\\
0 & \sigma_{\gamma[M]} & 0 & 0 & 0\\
0 & 0 & \sigma_{\gamma[D]} & 0 & 0\\
0 & 0 & 0 & \sigma_{\gamma[F]} & 0\\
0 & 0 & 0 & 0 & \sigma_{\gamma[L]}
\end{bmatrix}.
$$

Priors for fixed effects $\beta$ are the same as in the abundance model ($\mathrm{Normal}(0,1)$) except for the intercepts of the time to maturity and longevity submodels. For these, priors were shifted to $\mathrm{Normal}(3.4,1)$ based on knowledge that typical development times and adult longevity in *Erigone* are on the order of 30 days (i.e. $\simeq \exp(3.4)$) <!--add REF-->. We used $\mathrm{Half-Normal(0,1)}$ priors for all standard deviations $\sigma$ (including the residual SD $\sigma_{r}$ for the size submodel), and a $\mathrm{LKJCorr}(3)$ prior for the correlation matrix $R$ of individual-level random effects. Note that our LKJ prior is narrower than the one used in McElreath (2021)<!--add REF-->($\mathrm{LKJCorr}(2)$); in effect this penalizes against strong correlations (i.e. against our hypotheses of interest) unless support from the data is substantial.
 
## Splitting among- and within-family correlations

In a second time, we refitted the above model, this time splitting the individual-level variation into its within- and among-family components. The model is largely as above, with two exceptions:

- first, individuals $i$ are not only indexed by their patch of origin $p$, but also by their mother $m$ (so the dispersal propensity $D_{i,p}$ is now written $D_{i,m,p}$)

- second, the individual-level random effects $\gamma$, and the corresponding covariance, are decomposed into a sum of family-level random effects $\eta$ and the remaining within-family individual effects $\nu$ as follows:

$$
\gamma_{[S]i,m,p} =  \eta_{[S]m,p} + \nu_{[S]i,m,p},
$$
$$
\gamma_{[M]i,m,p} =  \eta_{[M]m,p} + \nu_{[M]i,m,p},
$$
$$
\gamma_{[D]i,m,p} =  \eta_{[D]m,p} + \nu_{[D]i,m,p},
$$
$$
\gamma_{[F]i,m,p} =  \eta_{[F]m,p} + \nu_{[F]i,m,p},
$$
$$
\gamma_{[L]i,m,p} =  \eta_{[L]m,p} + \nu_{[L]i,m,p},
$$

$$
\begin{bmatrix} \eta_{[S]i} \\ \eta_{[M]i} \\ \eta_{[D]i} \\ \eta_{[F]i} \\ \eta_{[L]i} \end{bmatrix} 
\sim 
\textrm{MVNormal}
\begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \\ 0  \end{bmatrix},
\boldsymbol{\Omega_{\eta}}
\end{pmatrix},
$$
$$
\boldsymbol{\Omega_{\eta}} = 
\begin{bmatrix}
\sigma_{\eta[S]} & 0 & 0 & 0 & 0\\
0 & \sigma_{\eta[M]} & 0 & 0 & 0\\
0 & 0 & \sigma_{\eta[D]} & 0 & 0\\
0 & 0 & 0 & \sigma_{\eta[F]} & 0\\
0 & 0 & 0 & 0 & \sigma_{\eta[L]}
\end{bmatrix}
\boldsymbol{R_{\eta}}
\begin{bmatrix}
\sigma_{\eta[S]} & 0 & 0 & 0 & 0\\
0 & \sigma_{\eta[M]} & 0 & 0 & 0\\
0 & 0 & \sigma_{\eta[D]} & 0 & 0\\
0 & 0 & 0 & \sigma_{\eta[F]} & 0\\
0 & 0 & 0 & 0 & \sigma_{\eta[L]}
\end{bmatrix},
$$
$$
\begin{bmatrix} \nu_{[S]i} \\ \nu_{[M]i} \\ \nu_{[D]i} \\ \nu_{[F]i} \\ \nu_{[L]i} \end{bmatrix} 
\sim 
\textrm{MVNormal}
\begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \\ 0  \end{bmatrix},
\boldsymbol{\Omega_{\nu}}
\end{pmatrix},
$$
$$
\boldsymbol{\Omega_{\nu}} = 
\begin{bmatrix}
\sigma_{\nu[S]} & 0 & 0 & 0 & 0\\
0 & \sigma_{\nu[M]} & 0 & 0 & 0\\
0 & 0 & \sigma_{\nu[D]} & 0 & 0\\
0 & 0 & 0 & \sigma_{\nu[F]} & 0\\
0 & 0 & 0 & 0 & \sigma_{\nu[L]}
\end{bmatrix}
\boldsymbol{R_{\nu}}
\begin{bmatrix}
\sigma_{\nu[S]} & 0 & 0 & 0 & 0\\
0 & \sigma_{\nu[M]} & 0 & 0 & 0\\
0 & 0 & \sigma_{\nu[D]} & 0 & 0\\
0 & 0 & 0 & \sigma_{\nu[F]} & 0\\
0 & 0 & 0 & 0 & \sigma_{\nu[L]}
\end{bmatrix}.
$$

# Supplementary Material 4. Effect of landscape of origin on abundance, revisited

```{r, results="hide"}
sites2<-sites %>% 
  mutate(landscape=fct_relevel(landscape,"west",after=0))
  
mod_pop_suppl=brm(
  N_adult_females|rate(person_hours_on_patch)~
    landscape,family=poisson,
  data=sites2,
  prior=c(
    set_prior("normal(0,1)",class="Intercept"),
    set_prior("normal(0,1)",class="b")
  ),
        iter=6000,warmup=3000,chains=4,
        seed=42,
        backend="cmdstanr"
)
```


```{r}
newdata_pop<-sites2 %>% 
  select(landscape) %>% 
  distinct() %>% 
  mutate(person_hours_on_patch=1) %>% 
  add_fitted_draws(mod_pop_suppl)
  
plot2<-ggplot()+
  stat_eye(data=newdata_pop,aes(landscape,.value),
           slab_alpha=0.5,
           fill="#238443",
           .width=c(0.001,0.95),
           point_interval="mean_hdi")+
  geom_jitter(data=sites2,aes(landscape,N_adult_females/person_hours_on_patch),
              position=position_jitter(width=0.2),pch=21,size=2,fill="white")+
  scale_x_discrete("landscape of origin")+
  scale_y_continuous("Population density (female *E. longipalpis* per person-hour)")+
  theme_bw()+
  theme(axis.title.y = element_markdown())

plot2
```

**Figure S4.1.** Effect of landscape of origin on the number of spiders found per patch (weighted by sampling effort). White dots corresponding to observed data are shown alongside model posteriors.Contrary to main text **Fig. 2**, all visited patches are included here, even those where *Puccinellia maritima* is not dominant.


# Supplementary Material 5. Effect of landscape of origin on phenotypic traits, revisited

```{r}
load(here("R_output", "multivar_mod_2.Rdata"))

newdata_maturity<-data %>% 
  select(landscape) %>% 
  distinct() %>% 
  mutate(is.valid_maturity=1, obsgap_maturity="no") %>% 
  add_epred_draws(mmod2,resp="timetomaturity",re_formula = NA)

plot3_a<-ggplot()+
  geom_boxplot(data=subset(data,is.valid_maturity==1),
               aes(landscape,time_to_maturity, group=patch),col="grey50")+
  stat_eye(data=newdata_maturity,aes(landscape,.epred),
           slab_alpha=0.5,
           fill="#238443",
           .width=c(0.001,0.95),
           point_interval="mean_hdi")+
  scale_x_discrete("")+
  scale_y_continuous("Age at maturity (days)")

newdata_size<-data %>% 
  select(landscape) %>% 
  distinct() %>%  
  add_epred_draws(mmod2,resp="sCTwidth",re_formula = NA) %>% 
  mutate(.epred=(.epred*sd(data$CT_width,na.rm=TRUE))+mean(data$CT_width,na.rm=TRUE))
# we back transform the predictions from scaled values to observed

plot3_b<-ggplot()+
  geom_boxplot(data=data,aes(landscape,CT_width, group=patch),col="grey50")+
  stat_eye(data=newdata_size,aes(landscape,.epred),
           slab_alpha=0.5,
           fill="#238443",
           .width=c(0.001,0.95),
           point_interval="mean_hdi")+
  scale_x_discrete("")+
  scale_y_continuous("Adult size (mm)")

newdata_dispersal<-data %>% 
  select(landscape) %>% 
  distinct() %>% 
  mutate(is.valid_dispersal=1) %>% 
  add_epred_draws(mmod2,resp="Nrappelling",re_formula = NA)

plot3_c<-ggplot()+
  geom_boxplot(data=subset(data,is.valid_dispersal==1),
               aes(landscape,N_rappelling, group=patch),col="grey50")+
  stat_eye(data=newdata_dispersal,aes(landscape,.epred),
           slab_alpha=0.5,
           fill="#238443",
           .width=c(0.001,0.95),
           point_interval="mean_hdi")+
  scale_x_discrete("")+
  scale_y_continuous("Dispersal (# rappelling attempts)")

newdata_fecundity<-data %>% 
  select(landscape) %>% 
  distinct() %>% 
  mutate(is.valid_fecundity=1,time_for_repro=1) %>% 
  add_epred_draws(mmod2,resp="lifetimefecundity",re_formula = NA)

plot3_d<-ggplot()+
  geom_boxplot(data=subset(data,is.valid_fecundity==1),
               aes(landscape,lifetime_fecundity/time_for_repro, group=patch),col="grey50")+
  stat_eye(data=newdata_fecundity,aes(landscape,.epred),
           slab_alpha=0.5,
           fill="#238443",
           .width=c(0.001,0.95),
           point_interval="mean_hdi")+
  scale_x_discrete("landscape of origin")+
  scale_y_continuous("Fecundity (# offspring/day)")


newdata_longevity<-data %>% 
  select(landscape) %>% 
  distinct() %>% 
  mutate(is.valid_longevity=1,obsgap_longevity="no") %>% 
  add_epred_draws(mmod2,resp="adultlongevity",re_formula = NA)

plot3_e<-ggplot()+
  geom_boxplot(data=subset(data,is.valid_longevity==1),
               aes(landscape,adult_longevity, group=patch),col="grey50")+
  stat_eye(data=newdata_longevity,aes(landscape,.epred),
           slab_alpha=0.5,
           fill="#238443",
           .width=c(0.001,0.95),
           point_interval="mean_hdi")+
  scale_x_discrete("")+
  scale_y_continuous("Adult longevity (days)")


layout <- "
AB#
CDE
"
plot3_a+plot3_b+plot3_c+plot3_d+plot3_e + 
  plot_layout(design = layout) & theme_bw()
```

**Figure S5.1.** Phenotypic traits of lab-born spiders as a function of landscape of origin. Observed data are displayed as boxplots (one boxplot per patch of origin), alongside model posteriors. Predictions are based on the model where individual trait co-variance **is** partitioned between among- and within-family components; see main text **Fig. 3** for a similar figure based on the model where individual-level variation is **not** partitioned.

# Supplementary Material 6: overall within-patch, individual-level correlations among traits, based on the "split variance" model

**Supplementary Table S6.1.** Means and 95% Higher Posterior Density intervals for the overall individual-level correlations among traits, based on the model where individual-level (co-)variance is split into among- and within-family levels (compare with **Table 1a** in the main text, which is based on the model where individual-level variation is **not** split into its among- and within-family components).
<!--see main code for the source info for this table-->

|  |Time to maturity| Body size| Dispersal| Fecundity |
|-----|-----|-----|-----|-----|
|Body size| -0.36 [-0.52; -0.20] |                     |                     |                     |
| Dispersal| -0.28 [-0.45; -0.09] | 0.12 [-0.02; 0.24]   |                     |                     |
| Fecundity| -0.28 [-0.46; -0.10] | 0.27 [0.11; 0.43]   | 0.14 [0.02; 0.28]   |                     |
| Adult longevity| 0.01 [-0.16; 0.19]   | -0.23 [-0.36; -0.09] | 0.11 [-0.03; 0.26]  | -0.05 [-0.21; 0.11] |
